<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<meta name="author" content="Yoon GeonWook">
<meta name="dcterms.date" content="2023-12-08">
<meta name="description" content="Data Mart 구성 및 Feature Engineering">
<title>GeonWook - E-commerce 데이터 분석 (2)</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>

<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../images/study.png" rel="icon" type="image/png">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light"><script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script><link rel="stylesheet" href="../../styles.css">
<meta property="og:title" content="GeonWook - E-commerce 데이터 분석 (2)">
<meta property="og:description" content="Data Mart 구성 및 Feature Engineering">
<meta property="og:image" content="https://gwook.blog/blog/2023-12-08-ecommerce-data-analysis(2)/ecommerce2.png">
<meta property="og:site-name" content="GeonWook">
<meta property="og:image:height" content="1920">
<meta property="og:image:width" content="1920">
</head>
<body class="floating nav-fixed slimcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="navbar navbar-expand-lg navbar-dark "><div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">GeonWook</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
<li class="nav-item">
    <a class="nav-link" href="../../index.html" rel="" target="">
 <span class="menu-text">Blog</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../about/index.html" rel="" target="">
 <span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/YoonGeonWook" rel="" target=""><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
<div class="quarto-navbar-tools">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav></header><!-- content --><header id="title-block-header" class="quarto-title-block default toc-left page-columns page-full"><div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">E-commerce 데이터 분석 (2)</h1>
                  <div>
        <div class="description">
          <p>Data Mart 구성 및 Feature Engineering</p>
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">machine learning</div>
                <div class="quarto-category">statistics</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Yoon GeonWook </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">December 8, 2023</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto"><nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">On this page</h2>
   
  <ul>
<li>
<a href="#sec-3" id="toc-sec-3" class="nav-link active" data-scroll-target="#sec-3">03. Data Mart &amp; Feature Engineering</a>
  <ul class="collapse">
<li><a href="#data-mart-%EA%B8%B0%ED%9A%8D-%EB%B0%8F-%EC%84%A4%EA%B3%84" id="toc-data-mart-기획-및-설계" class="nav-link" data-scroll-target="#data-mart-%EA%B8%B0%ED%9A%8D-%EB%B0%8F-%EC%84%A4%EA%B3%84">03-01. Data Mart 기획 및 설계</a></li>
  <li>
<a href="#data-%EC%B6%94%EC%B6%9C-%EB%B0%8F-mart-%EA%B0%9C%EB%B0%9C" id="toc-data-추출-및-mart-개발" class="nav-link" data-scroll-target="#data-%EC%B6%94%EC%B6%9C-%EB%B0%8F-mart-%EA%B0%9C%EB%B0%9C">03-02. Data 추출 및 Mart 개발</a>
  <ul class="collapse">
<li><a href="#mart-%EA%B5%AC%EC%84%B1" id="toc-mart-구성" class="nav-link" data-scroll-target="#mart-%EA%B5%AC%EC%84%B1">Mart 구성</a></li>
  </ul>
</li>
  <li>
<a href="#numeric-feature-engineering" id="toc-numeric-feature-engineering" class="nav-link" data-scroll-target="#numeric-feature-engineering">03-03. Numeric Feature Engineering</a>
  <ul class="collapse">
<li><a href="#feature-engineering" id="toc-feature-engineering" class="nav-link" data-scroll-target="#feature-engineering">Feature Engineering</a></li>
  <li><a href="#information-value" id="toc-information-value" class="nav-link" data-scroll-target="#information-value">Information Value</a></li>
  </ul>
</li>
  <li><a href="#categorical-feature-engineering" id="toc-categorical-feature-engineering" class="nav-link" data-scroll-target="#categorical-feature-engineering">03-03. Categorical Feature Engineering</a></li>
  </ul>
</li>
  </ul><div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/YoonGeonWook/GWook-com/blob/main/blog/2023-12-08-ecommerce-data-analysis(2)/index.qmd" class="toc-action">View source</a></p><p><a href="https://github.com/YoonGeonWook/GWook-com/edit/main/blog/2023-12-08-ecommerce-data-analysis(2)/index.qmd" class="toc-action">Edit this page</a></p><p><a href="https://github.com/YoonGeonWook/GWook-com/issues/new" class="toc-action">Report an issue</a></p></div></div></nav>
</nav><div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
    </div>
<!-- main -->
<main class="content quarto-banner-title-block page-columns page-full" id="quarto-document-content"><p>본 포스팅은 패스트캠퍼스 <a href="https://fastcampus.co.kr/data_online_msignature">50개 프로젝트로 완벽하게 끝내는 머신러닝 시그니쳐</a>의 강의내용을 바탕으로 참고하여 작성하였습니다.</p>
<p>앞서 <a href="https://gwook.blog/blog/2023-12-03-ecommerce-data-analysis/">E-commerce 데이터 분석 (1)</a>에서 A사가 운영하는 이커머스 플랫폼의 ②유입 고객 재구매를 촉진시키기 위해 7단계의 문제해결 프로세스를 정의했으며, Step 5의 데이터 분석 단계에 필요한 과정을 진행했습니다.</p>
<section id="sec-3" class="level1 page-columns page-full"><h1>03. Data Mart &amp; Feature Engineering</h1>
<section id="data-mart-기획-및-설계" class="level2 page-columns page-full"><h2 class="anchored" data-anchor-id="data-mart-기획-및-설계">03-01. Data Mart 기획 및 설계</h2>
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full"><p><img src="data-mart.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption margin-caption">모델링을 위한 Data Mart 기획</figcaption></figure>
</div>
<div class="cell" data-hash="index_cache/html/unnamed-chunk-1_08e65167ea0d5663cd79ed091b0ea576">

</div>
<p>고객 24,983명에 대한 거래 이력이 총 78만 건 정도였고, 이를 고객 데이터셋을 Undersampling 하여 추출한 분석 대상이 7,495명의 고객 데이터인 상황입니다. UCI Machine Learning Repository의 Online Retail 데이터를 Data Warehouse에서 가져온 데이터이고, 이를 이용해 고객별 구매 이력에 대한 Data Mart를 구성하려고 합니다. 이제 여러 가설을 세워 재구매 여부 <code>target</code>에 영향을 미치는 여러 변수(features)를 만들어 보겠습니다. 아래는 Data Mart를 구성하는 여러 feature 에 대한 설명과 로직이 작성되어 있는 Data Mart 기획서입니다.</p>
<div id="fig-1" class="quarto-figure quarto-figure-center anchored page-columns page-full">
<figure class="figure page-columns page-full"><p><img src="data-mart-desc.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption margin-caption">Figure&nbsp;1: Data Mart 기획서</figcaption></figure>
</div>
</section><section id="data-추출-및-mart-개발" class="level2"><h2 class="anchored" data-anchor-id="data-추출-및-mart-개발">03-02. Data 추출 및 Mart 개발</h2>
<p>기본적인 전처리가 끝난 후 데이터를 <code>df_origin</code>로 저장되어 있습니다. 샘플링한 표본 데이터를 대상으로 Mart를 구성하기 위해서, 우선 <code>df_origin</code>과 표본 데이터 <code>df_all_sample</code>에 <code>bsym</code>과 <code>CustomerID</code>를 조합해 key 변수를 만들어 보겠습니다.</p>
<div class="cell" data-hash="index_cache/html/unnamed-chunk-2_3f0299b26986d98aa87994610ac91f05">
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">df_origin</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 9
  InvoiceNo StockCode Description                           Quantity InvoiceDate         UnitPrice CustomerID Country        bsym   
  &lt;chr&gt;     &lt;chr&gt;     &lt;chr&gt;                                    &lt;int&gt; &lt;dttm&gt;                  &lt;dbl&gt; &lt;chr&gt;      &lt;chr&gt;          &lt;chr&gt;  
1 489434    85048     "15CM CHRISTMAS GLASS BALL 20 LIGHTS"       12 2009-12-01 07:45:00      6.95 13085      United Kingdom 2009-12
2 489434    79323P    "PINK CHERRY LIGHTS"                        12 2009-12-01 07:45:00      6.75 13085      United Kingdom 2009-12
3 489434    79323W    "WHITE CHERRY LIGHTS"                       12 2009-12-01 07:45:00      6.75 13085      United Kingdom 2009-12
4 489434    22041     "RECORD FRAME 7\" SINGLE SIZE"              48 2009-12-01 07:45:00      2.1  13085      United Kingdom 2009-12
5 489434    21232     "STRAWBERRY CERAMIC TRINKET BOX"            24 2009-12-01 07:45:00      1.25 13085      United Kingdom 2009-12
6 489434    22064     "PINK DOUGHNUT TRINKET POT"                 24 2009-12-01 07:45:00      1.65 13085      United Kingdom 2009-12</code></pre>
</div>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">df_all_sample</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 3
  bsym    CustomerID target
  &lt;chr&gt;   &lt;chr&gt;       &lt;dbl&gt;
1 2009-12 12682           1
2 2009-12 15413           1
3 2009-12 16321           0
4 2009-12 15712           1
5 2009-12 17700           1
6 2009-12 14911           1</code></pre>
</div>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># df_origin에 key 변수 생성</span></span>
<span><span class="va">df_origin</span> <span class="op">&lt;-</span> <span class="va">df_origin</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>key <span class="op">=</span> <span class="fu">str_c</span><span class="op">(</span><span class="va">bsym</span>, <span class="va">CustomerID</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">df_origin</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">reframe</span><span class="op">(</span>n_key <span class="op">=</span> <span class="fu">n_distinct</span><span class="op">(</span><span class="va">key</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 1
  n_key
  &lt;int&gt;
1 25598</code></pre>
</div>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># df_all_sample에 key 변수 생성</span></span>
<span><span class="va">df_all_sample</span> <span class="op">&lt;-</span> <span class="va">df_all_sample</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>key <span class="op">=</span> <span class="fu">str_c</span><span class="op">(</span><span class="va">bsym</span>, <span class="va">CustomerID</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">df_all_sample</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">reframe</span><span class="op">(</span>n_key <span class="op">=</span> <span class="fu">n_distinct</span><span class="op">(</span><span class="va">key</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 1
  n_key
  &lt;int&gt;
1  7495</code></pre>
</div>
</div>
<p>이제 <code>df_origin</code>의 <code>key</code>를 이용해 <code>df_all_sample</code>에 존재하는 행들만 가져와 <code>df_origin_sample</code> 이라는 데이터를 만듭니다.</p>
<div class="cell" data-hash="index_cache/html/unnamed-chunk-3_3093076c4294c5149a459c5425618807">
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">df_origin_sample</span> <span class="op">&lt;-</span> <span class="va">df_origin</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">key</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="va">df_all_sample</span><span class="op">$</span><span class="va">key</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># df_origin과 df_origin_sample의 비율: 대략 30% 정도</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">df_origin_sample</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">df_origin</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.2947758</code></pre>
</div>
</div>
<section id="mart-구성" class="level3"><h3 class="anchored" data-anchor-id="mart-구성">Mart 구성</h3>
<section id="구매금액" class="level4"><h4 class="anchored" data-anchor-id="구매금액"><strong>구매금액</strong></h4>
<ul>
<li>Idea: 월별 구매금액에 따라 다음 달 재구매 확률이 다를 것이다</li>
</ul>
<p>Mart 기획서의 첫 번째 <strong>구매금액</strong> 관련 3개의 변수를 만들기 위해 <code>StockCode</code> 당 구매금액을 나타내는 변수 <code>amt</code>를 <code>UnitPrice * Quantity</code>로 정의하겠습니다.</p>
<div class="cell" data-hash="index_cache/html/unnamed-chunk-4_d40af0b512c611c1c59f7faad1646fee">
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># 1. 구매금액 amt 관련 변수 , max_amt, min_amt</span></span>
<span><span class="co">## 1) total_amt: 당월 총 구매금액</span></span>
<span><span class="va">df_mart</span> <span class="op">&lt;-</span> <span class="va">df_origin_sample</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>amt <span class="op">=</span> <span class="va">UnitPrice</span> <span class="op">*</span> <span class="va">Quantity</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">bsym</span>, <span class="va">CustomerID</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">reframe</span><span class="op">(</span>total_amt <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">amt</span>, na.rm <span class="op">=</span> <span class="cn">T</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## 2) max_amt, min_amt: 당월 송장당 최대/최소 구매금액</span></span>
<span><span class="va">df_mart</span> <span class="op">&lt;-</span> <span class="va">df_mart</span> <span class="op">%&gt;%</span> <span class="fu">left_join</span><span class="op">(</span></span>
<span>  <span class="va">df_origin_sample</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>amt <span class="op">=</span> <span class="va">UnitPrice</span> <span class="op">*</span> <span class="va">Quantity</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">bsym</span>, <span class="va">CustomerID</span>, <span class="va">InvoiceNo</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">reframe</span><span class="op">(</span>amt <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">amt</span>, na.rm <span class="op">=</span> <span class="cn">T</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">bsym</span>, <span class="va">CustomerID</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">reframe</span><span class="op">(</span>max_amt <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">amt</span>, na.rm <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>,</span>
<span>          min_amt <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">amt</span>, na.rm <span class="op">=</span> <span class="cn">T</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"bsym"</span>, <span class="st">"CustomerID"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">df_mart</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 5
  bsym    CustomerID total_amt max_amt min_amt
  &lt;chr&gt;   &lt;chr&gt;          &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;
1 2009-12 12437          578.    578.    578. 
2 2009-12 12523           74.6    74.6    74.6
3 2009-12 12539         5149.   2583.   2566. 
4 2009-12 12557         1953.   1953.   1953. 
5 2009-12 12664          549.    549.    549. 
6 2009-12 12681         1015.   1015.   1015. </code></pre>
</div>
</div>
</section><section id="구매건수" class="level4"><h4 class="anchored" data-anchor-id="구매건수"><strong>구매건수</strong></h4>
<ul>
<li>Idea: 월별 구매건수에 따라 다음 달 재구매 확률이 다를 것이다</li>
</ul>
<p>이제 구매건수(<code>cnt</code>)와 관련된 변수 3가지를 만들겠습니다. 월별 총 구매건수는 <code>total_cnt</code>로, 월별 송장(<code>InvoiceNo</code>)별 구매 품목 수의 최대/최소는 <code>max_cnt</code>, <code>min_cnt</code>로 정의하겠습니다.</p>
<div class="cell" data-hash="index_cache/html/unnamed-chunk-5_e2af5e531eae8bbec9a6e977b3083b4d">
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># 2. 구매건수 cnt 관련 변수</span></span>
<span><span class="co">## 1) total_cnt: 당월 총 구매건수</span></span>
<span><span class="va">df_mart</span> <span class="op">&lt;-</span> <span class="va">df_mart</span> <span class="op">%&gt;%</span> <span class="fu">left_join</span><span class="op">(</span></span>
<span>  <span class="va">df_origin_sample</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">bsym</span>, <span class="va">CustomerID</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">reframe</span><span class="op">(</span>total_cnt <span class="op">=</span> <span class="fu">n_distinct</span><span class="op">(</span><span class="va">InvoiceNo</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"bsym"</span>, <span class="st">"CustomerID"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">## 2) max_cnt, min_cnt: InvoiceNo별 최대/최소 구매 품목 수</span></span>
<span><span class="va">df_mart</span> <span class="op">&lt;-</span> <span class="va">df_mart</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">left_join</span><span class="op">(</span></span>
<span>    <span class="va">df_origin_sample</span> <span class="op">%&gt;%</span> </span>
<span>      <span class="fu">group_by</span><span class="op">(</span><span class="va">bsym</span>, <span class="va">CustomerID</span>, <span class="va">InvoiceNo</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>      <span class="fu">reframe</span><span class="op">(</span>cnt <span class="op">=</span> <span class="fu">n_distinct</span><span class="op">(</span><span class="va">StockCode</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>      <span class="fu">group_by</span><span class="op">(</span><span class="va">bsym</span>, <span class="va">CustomerID</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>      <span class="fu">reframe</span><span class="op">(</span>max_cnt <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">cnt</span>, na.rm <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>,</span>
<span>              min_cnt <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">cnt</span>, na.rm <span class="op">=</span> <span class="cn">T</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"bsym"</span>, <span class="st">"CustomerID"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">df_mart</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 8
  bsym    CustomerID total_amt max_amt min_amt total_cnt max_cnt min_cnt
  &lt;chr&gt;   &lt;chr&gt;          &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;     &lt;int&gt;   &lt;int&gt;   &lt;int&gt;
1 2009-12 12437          578.    578.    578.          1      27      27
2 2009-12 12523           74.6    74.6    74.6         1       4       4
3 2009-12 12539         5149.   2583.   2566.          2     104     103
4 2009-12 12557         1953.   1953.   1953.          1       3       3
5 2009-12 12664          549.    549.    549.          1       4       4
6 2009-12 12681         1015.   1015.   1015.          1      46      46</code></pre>
</div>
</div>
</section><section id="구매수량" class="level4"><h4 class="anchored" data-anchor-id="구매수량"><strong>구매수량</strong></h4>
<ul>
<li>Idea: 월별 구매수량에 따라 다음 달 재구매 확률이 다를 것이다</li>
</ul>
<div class="cell" data-hash="index_cache/html/unnamed-chunk-6_4b6b109fa6b385c66dd1f497b7f0b04e">
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># 3. 구매수량 qty 관련 변수</span></span>
<span><span class="co">## 1) total_qty: 당월 총 구매수량</span></span>
<span><span class="va">df_mart</span> <span class="op">&lt;-</span> <span class="va">df_mart</span> <span class="op">%&gt;%</span> <span class="fu">left_join</span><span class="op">(</span></span>
<span>  <span class="va">df_origin_sample</span> <span class="op">%&gt;%</span> </span>
<span>    <span class="fu">group_by</span><span class="op">(</span><span class="va">bsym</span>, <span class="va">CustomerID</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>    <span class="fu">reframe</span><span class="op">(</span>total_qty <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">Quantity</span>, na.rm <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>,</span>
<span>            max_qty <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">Quantity</span>, na.rm <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>,</span>
<span>            min_qty <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">Quantity</span>, na.rm <span class="op">=</span> <span class="cn">T</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"bsym"</span>, <span class="st">"CustomerID"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">df_mart</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 11
  bsym    CustomerID total_amt max_amt min_amt total_cnt max_cnt min_cnt total_qty max_qty min_qty
  &lt;chr&gt;   &lt;chr&gt;          &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;     &lt;int&gt;   &lt;int&gt;   &lt;int&gt;     &lt;int&gt;   &lt;int&gt;   &lt;int&gt;
1 2009-12 12437          578.    578.    578.          1      27      27       263      24       3
2 2009-12 12523           74.6    74.6    74.6         1       4       4        62      36       4
3 2009-12 12539         5149.   2583.   2566.          2     104     103      2128      48       2
4 2009-12 12557         1953.   1953.   1953.          1       3       3       576     216     144
5 2009-12 12664          549.    549.    549.          1       4       4       134      72       2
6 2009-12 12681         1015.   1015.   1015.          1      46      46       650      72       1</code></pre>
</div>
</div>
</section><section id="국적" class="level4"><h4 class="anchored" data-anchor-id="국적"><strong>국적</strong></h4>
<ul>
<li>Idea: 국적에 따라 재구매 확률이 다를 것이다</li>
</ul>
<div class="cell" data-hash="index_cache/html/unnamed-chunk-7_56eed77e696dcb0946849879b5ea9837">
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># 4. 국적 변수 생성</span></span>
<span><span class="va">df_mart</span> <span class="op">&lt;-</span> <span class="va">df_mart</span> <span class="op">%&gt;%</span> <span class="fu">left_join</span><span class="op">(</span></span>
<span>  <span class="va">df_origin_sample</span> <span class="op">%&gt;%</span> </span>
<span>    <span class="fu">group_by</span><span class="op">(</span><span class="va">bsym</span>, <span class="va">CustomerID</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>    <span class="fu">reframe</span><span class="op">(</span>Country <span class="op">=</span> <span class="fu">first</span><span class="op">(</span><span class="va">Country</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"bsym"</span>, <span class="st">"CustomerID"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">df_mart</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 12
  bsym    CustomerID total_amt max_amt min_amt total_cnt max_cnt min_cnt total_qty max_qty min_qty Country
  &lt;chr&gt;   &lt;chr&gt;          &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;     &lt;int&gt;   &lt;int&gt;   &lt;int&gt;     &lt;int&gt;   &lt;int&gt;   &lt;int&gt; &lt;chr&gt;  
1 2009-12 12437          578.    578.    578.          1      27      27       263      24       3 France 
2 2009-12 12523           74.6    74.6    74.6         1       4       4        62      36       4 France 
3 2009-12 12539         5149.   2583.   2566.          2     104     103      2128      48       2 Spain  
4 2009-12 12557         1953.   1953.   1953.          1       3       3       576     216     144 Spain  
5 2009-12 12664          549.    549.    549.          1       4       4       134      72       2 Finland
6 2009-12 12681         1015.   1015.   1015.          1      46      46       650      72       1 France </code></pre>
</div>
</div>
</section><section id="구매-시간대" class="level4"><h4 class="anchored" data-anchor-id="구매-시간대"><strong>구매 시간대</strong></h4>
<ul>
<li>Idea: 구매 시간대(아침, 점심, 저녁, 밤)에 따라 재구매 확률이 다를 것이다</li>
</ul>
<p>월별 고객별 아침, 점심, 저녁, 밤에 따른 구매 빈도를 구한 후 가장 많은 시간대를 <code>peak_time</code>이라는 이름의 feature로 선택하겠습니다.</p>
<div class="cell" data-hash="index_cache/html/unnamed-chunk-8_1055e0d43034bc2cea05badd6551e73a">
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># 5. 구매 시간대(아침, 점심, 저녁, 밤)</span></span>
<span><span class="co">## 아침: 6~12시, 점심: 12~18시, 저녁: 18~24시, 밤: 0~6시</span></span>
<span><span class="co">## 시간대별 구매 빈도 계산</span></span>
<span><span class="va">df_mart</span> <span class="op">&lt;-</span> <span class="va">df_mart</span> <span class="op">%&gt;%</span> <span class="fu">left_join</span><span class="op">(</span></span>
<span>  <span class="va">df_origin_sample</span> <span class="op">%&gt;%</span> </span>
<span>    <span class="fu">mutate</span><span class="op">(</span>hour <span class="op">=</span> <span class="fu">hour</span><span class="op">(</span><span class="va">InvoiceDate</span><span class="op">)</span>,</span>
<span>           peak_time <span class="op">=</span> <span class="fu">case_when</span><span class="op">(</span></span>
<span>             <span class="va">hour</span> <span class="op">&gt;=</span> <span class="fl">6</span>  <span class="op">&amp;</span> <span class="va">hour</span> <span class="op">&lt;</span> <span class="fl">12</span> <span class="op">~</span> <span class="st">"Morning"</span>,</span>
<span>             <span class="va">hour</span> <span class="op">&gt;=</span> <span class="fl">12</span> <span class="op">&amp;</span> <span class="va">hour</span> <span class="op">&lt;</span> <span class="fl">18</span> <span class="op">~</span> <span class="st">"Afternoon"</span>,</span>
<span>             <span class="va">hour</span> <span class="op">&gt;=</span> <span class="fl">18</span> <span class="op">&amp;</span> <span class="va">hour</span> <span class="op">&lt;</span> <span class="fl">24</span> <span class="op">~</span> <span class="st">"Evening"</span>,</span>
<span>             <span class="cn">TRUE</span> <span class="op">~</span> <span class="st">"Night"</span></span>
<span>           <span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>    <span class="fu">group_by</span><span class="op">(</span><span class="va">bsym</span>, <span class="va">CustomerID</span>, <span class="va">peak_time</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>    <span class="fu">reframe</span><span class="op">(</span>purchase_cnt <span class="op">=</span> <span class="fu">n</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>    <span class="fu">group_by</span><span class="op">(</span><span class="va">bsym</span>, <span class="va">CustomerID</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>    <span class="fu">slice_max</span><span class="op">(</span><span class="va">purchase_cnt</span>, n <span class="op">=</span> <span class="fl">1</span>, with_ties <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>    <span class="fu">select</span><span class="op">(</span><span class="op">-</span><span class="va">purchase_cnt</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>    <span class="fu">ungroup</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"bsym"</span>, <span class="st">"CustomerID"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">df_mart</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 13
  bsym    CustomerID total_amt max_amt min_amt total_cnt max_cnt min_cnt total_qty max_qty min_qty Country peak_time
  &lt;chr&gt;   &lt;chr&gt;          &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;     &lt;int&gt;   &lt;int&gt;   &lt;int&gt;     &lt;int&gt;   &lt;int&gt;   &lt;int&gt; &lt;chr&gt;   &lt;chr&gt;    
1 2009-12 12437          578.    578.    578.          1      27      27       263      24       3 France  Afternoon
2 2009-12 12523           74.6    74.6    74.6         1       4       4        62      36       4 France  Afternoon
3 2009-12 12539         5149.   2583.   2566.          2     104     103      2128      48       2 Spain   Afternoon
4 2009-12 12557         1953.   1953.   1953.          1       3       3       576     216     144 Spain   Morning  
5 2009-12 12664          549.    549.    549.          1       4       4       134      72       2 Finland Morning  
6 2009-12 12681         1015.   1015.   1015.          1      46      46       650      72       1 France  Afternoon</code></pre>
</div>
</div>
</section><section id="계절" class="level4"><h4 class="anchored" data-anchor-id="계절"><strong>계절</strong></h4>
<ul>
<li>Idea: 계절에 따라 재구매 확률이 다를 것이다</li>
</ul>
<div class="cell" data-hash="index_cache/html/unnamed-chunk-9_66c8b457754285bae871069cb58924c4">
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># 6. 계절 변수 추가</span></span>
<span><span class="va">df_mart</span> <span class="op">&lt;-</span> <span class="va">df_mart</span> <span class="op">%&gt;%</span> <span class="fu">left_join</span><span class="op">(</span></span>
<span>  <span class="va">df_origin_sample</span> <span class="op">%&gt;%</span> </span>
<span>    <span class="fu">mutate</span><span class="op">(</span>month <span class="op">=</span> <span class="fu">month</span><span class="op">(</span><span class="va">InvoiceDate</span><span class="op">)</span>,</span>
<span>           season <span class="op">=</span> <span class="fu">case_when</span><span class="op">(</span></span>
<span>             <span class="va">month</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">3</span>,<span class="fl">4</span>,<span class="fl">5</span><span class="op">)</span> <span class="op">~</span> <span class="st">"Spring"</span>,</span>
<span>             <span class="va">month</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">6</span>,<span class="fl">7</span>,<span class="fl">8</span><span class="op">)</span> <span class="op">~</span> <span class="st">"Summer"</span>,</span>
<span>             <span class="va">month</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">9</span>,<span class="fl">10</span>,<span class="fl">11</span><span class="op">)</span> <span class="op">~</span> <span class="st">"Autumn"</span>,</span>
<span>             <span class="cn">TRUE</span> <span class="op">~</span> <span class="st">"Winter"</span></span>
<span>           <span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>    <span class="fu">group_by</span><span class="op">(</span><span class="va">bsym</span>, <span class="va">CustomerID</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>    <span class="fu">reframe</span><span class="op">(</span>season <span class="op">=</span> <span class="fu">first</span><span class="op">(</span><span class="va">season</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"bsym"</span>, <span class="st">"CustomerID"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">df_mart</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 14
  bsym    CustomerID total_amt max_amt min_amt total_cnt max_cnt min_cnt total_qty max_qty min_qty Country peak_time season
  &lt;chr&gt;   &lt;chr&gt;          &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;     &lt;int&gt;   &lt;int&gt;   &lt;int&gt;     &lt;int&gt;   &lt;int&gt;   &lt;int&gt; &lt;chr&gt;   &lt;chr&gt;     &lt;chr&gt; 
1 2009-12 12437          578.    578.    578.          1      27      27       263      24       3 France  Afternoon Winter
2 2009-12 12523           74.6    74.6    74.6         1       4       4        62      36       4 France  Afternoon Winter
3 2009-12 12539         5149.   2583.   2566.          2     104     103      2128      48       2 Spain   Afternoon Winter
4 2009-12 12557         1953.   1953.   1953.          1       3       3       576     216     144 Spain   Morning   Winter
5 2009-12 12664          549.    549.    549.          1       4       4       134      72       2 Finland Morning   Winter
6 2009-12 12681         1015.   1015.   1015.          1      46      46       650      72       1 France  Afternoon Winter</code></pre>
</div>
</div>
</section><section id="구매-빈도" class="level4"><h4 class="anchored" data-anchor-id="구매-빈도"><strong>구매 빈도</strong></h4>
<ul>
<li>Idea: 구매 빈도가 높은 고객은 재구매 확률이 높을 것이다</li>
</ul>
<div class="cell" data-hash="index_cache/html/unnamed-chunk-10_aba2271bf30e5d1f2e906ba33b449e77">
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># 7. 당월 구매 빈도</span></span>
<span><span class="co">## freq = count(InvoiceNo) / # num of days in month</span></span>
<span><span class="va">df_mart</span> <span class="op">&lt;-</span> <span class="va">df_mart</span> <span class="op">%&gt;%</span> <span class="fu">left_join</span><span class="op">(</span></span>
<span>  <span class="va">df_origin_sample</span> <span class="op">%&gt;%</span> </span>
<span>    <span class="fu">group_by</span><span class="op">(</span><span class="va">bsym</span>, <span class="va">CustomerID</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>    <span class="fu">reframe</span><span class="op">(</span>cnt <span class="op">=</span> <span class="fu">n_distinct</span><span class="op">(</span><span class="va">InvoiceNo</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>    <span class="fu">mutate</span><span class="op">(</span></span>
<span>      tmp_date <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">bsym</span>, <span class="st">"-01"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>      days <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span><span class="op">(</span><span class="fu">day</span><span class="op">(</span><span class="fu">floor_date</span><span class="op">(</span><span class="va">tmp_date</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/weekday.POSIXt.html">months</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>, <span class="st">"month"</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span>,</span>
<span>      freq <span class="op">=</span> <span class="va">cnt</span> <span class="op">/</span> <span class="va">days</span></span>
<span>    <span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>    <span class="fu">select</span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">cnt</span>, <span class="va">tmp_date</span>, <span class="va">days</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"bsym"</span>, <span class="st">"CustomerID"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">df_mart</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 15
  bsym    CustomerID total_amt max_amt min_amt total_cnt max_cnt min_cnt total_qty max_qty min_qty Country peak_time season   freq
  &lt;chr&gt;   &lt;chr&gt;          &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;     &lt;int&gt;   &lt;int&gt;   &lt;int&gt;     &lt;int&gt;   &lt;int&gt;   &lt;int&gt; &lt;chr&gt;   &lt;chr&gt;     &lt;chr&gt;   &lt;dbl&gt;
1 2009-12 12437          578.    578.    578.          1      27      27       263      24       3 France  Afternoon Winter 0.0323
2 2009-12 12523           74.6    74.6    74.6         1       4       4        62      36       4 France  Afternoon Winter 0.0323
3 2009-12 12539         5149.   2583.   2566.          2     104     103      2128      48       2 Spain   Afternoon Winter 0.0645
4 2009-12 12557         1953.   1953.   1953.          1       3       3       576     216     144 Spain   Morning   Winter 0.0323
5 2009-12 12664          549.    549.    549.          1       4       4       134      72       2 Finland Morning   Winter 0.0323
6 2009-12 12681         1015.   1015.   1015.          1      46      46       650      72       1 France  Afternoon Winter 0.0323</code></pre>
</div>
</div>
</section><section id="평균-구매금액" class="level4"><h4 class="anchored" data-anchor-id="평균-구매금액"><strong>평균 구매금액</strong></h4>
<ul>
<li>Idea: 평균 구매금액에 따라 재구매 확률이 다를 것이다</li>
</ul>
<p>이 변수는 단순히 <code>total_amt</code>를 <code>total_cnt</code>로 나눈 값입니다.</p>
<div class="cell" data-hash="index_cache/html/unnamed-chunk-11_5d62ff9fd0067af47203d55204e0dab3">
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># 8. 평균 구매금액: avg_amt</span></span>
<span><span class="co">## 송장당 평균 구매금액</span></span>
<span><span class="va">df_mart</span> <span class="op">&lt;-</span> <span class="va">df_mart</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>avg_amt <span class="op">=</span> <span class="va">total_amt</span> <span class="op">/</span> <span class="va">total_cnt</span><span class="op">)</span></span>
<span></span>
<span><span class="va">df_mart</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 16
  bsym    CustomerID total_amt max_amt min_amt total_cnt max_cnt min_cnt total_qty max_qty min_qty Country peak_time season   freq avg_amt
  &lt;chr&gt;   &lt;chr&gt;          &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;     &lt;int&gt;   &lt;int&gt;   &lt;int&gt;     &lt;int&gt;   &lt;int&gt;   &lt;int&gt; &lt;chr&gt;   &lt;chr&gt;     &lt;chr&gt;   &lt;dbl&gt;   &lt;dbl&gt;
1 2009-12 12437          578.    578.    578.          1      27      27       263      24       3 France  Afternoon Winter 0.0323   578. 
2 2009-12 12523           74.6    74.6    74.6         1       4       4        62      36       4 France  Afternoon Winter 0.0323    74.6
3 2009-12 12539         5149.   2583.   2566.          2     104     103      2128      48       2 Spain   Afternoon Winter 0.0645  2575. 
4 2009-12 12557         1953.   1953.   1953.          1       3       3       576     216     144 Spain   Morning   Winter 0.0323  1953. 
5 2009-12 12664          549.    549.    549.          1       4       4       134      72       2 Finland Morning   Winter 0.0323   549. 
6 2009-12 12681         1015.   1015.   1015.          1      46      46       650      72       1 France  Afternoon Winter 0.0323  1015. </code></pre>
</div>
</div>
<p>이제 <code>target</code> 변수와 병합해 저장하겠습니다.</p>
<div class="cell" data-hash="index_cache/html/unnamed-chunk-12_d74734dcd10ec473fb2ae0af6f370d9d">
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">df_mart</span> <span class="op">&lt;-</span> <span class="va">df_mart</span> <span class="op">%&gt;%</span> <span class="fu">left_join</span><span class="op">(</span></span>
<span>  <span class="va">df_all_sample</span> <span class="op">%&gt;%</span> <span class="fu">select</span><span class="op">(</span><span class="op">-</span><span class="va">key</span><span class="op">)</span>,</span>
<span>  by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"bsym"</span>, <span class="st">"CustomerID"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">df_mart</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 17
  bsym    CustomerID total_amt max_amt min_amt total_cnt max_cnt min_cnt total_qty max_qty min_qty Country peak_time season   freq avg_amt target
  &lt;chr&gt;   &lt;chr&gt;          &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;     &lt;int&gt;   &lt;int&gt;   &lt;int&gt;     &lt;int&gt;   &lt;int&gt;   &lt;int&gt; &lt;chr&gt;   &lt;chr&gt;     &lt;chr&gt;   &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;
1 2009-12 12437          578.    578.    578.          1      27      27       263      24       3 France  Afternoon Winter 0.0323   578.       1
2 2009-12 12523           74.6    74.6    74.6         1       4       4        62      36       4 France  Afternoon Winter 0.0323    74.6      0
3 2009-12 12539         5149.   2583.   2566.          2     104     103      2128      48       2 Spain   Afternoon Winter 0.0645  2575.       0
4 2009-12 12557         1953.   1953.   1953.          1       3       3       576     216     144 Spain   Morning   Winter 0.0323  1953.       0
5 2009-12 12664          549.    549.    549.          1       4       4       134      72       2 Finland Morning   Winter 0.0323   549.       0
6 2009-12 12681         1015.   1015.   1015.          1      46      46       650      72       1 France  Afternoon Winter 0.0323  1015.       1</code></pre>
</div>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">df_mart</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 7495   17</code></pre>
</div>
</div>
</section></section></section><section id="numeric-feature-engineering" class="level2 page-columns page-full"><h2 class="anchored" data-anchor-id="numeric-feature-engineering">03-03. Numeric Feature Engineering</h2>
<section id="feature-engineering" class="level3"><h3 class="anchored" data-anchor-id="feature-engineering">Feature Engineering</h3>
<blockquote class="blockquote">
<p>Feature Enigneering이란?</p>
</blockquote>
<p>Feature들을 재구성하여 모델을 효과적으로 사용하기 쉽게 하는 작업을 말합니다. 즉, 모델링의 성능을 향상시키기 위해 feature를 생성, 선택, 가공하는 일련의 모든 활동을 의미합니다. Feature의 주요한 특징들을 잘 나타낼 수 있도록 변수의 변환, encoding 등의 작업들이 포함됩니다.</p>
<p>때로는 새로운 feature를 생성하기도 하고, 변환(transformation)도 가능합니다. 또한 Feature selection(변수 선택)과 Feature extraction(차원 축소)를 이용하기도 합니다.</p>
<p>현재 저희의 목적은 다음 달 재구매 여부 <code>target</code>을 잘 분류하는 모델을 구축하는 Classification 문제에 적합한 feature engineering 과정을 적용하겠습니다.</p>
</section><section id="information-value" class="level3 page-columns page-full"><h3 class="anchored" data-anchor-id="information-value">Information Value</h3>
<p>이진 분류 문제에서 Event(여기서 <code>target=1</code>인 경우)와 Non Event의 비율을 고려할 때, 각 비율의 불균형한 정도를 확연하게 보고 싶을 때 사용하는 방법입니다. WoE(Weight of Evidence) 값을 아래와 같이 정의해보겠습니다.</p>
<p><span class="math display">\[
\begin{aligned}
\text{WoE} &amp;= \text{log}\frac{p}{1-p}\\
where\quad p &amp;= Pr(Event)
\end{aligned}
\]</span></p>
<p>즉, WoE는 Event 비율의 Odds 값에 로그를 취한 Logit 값입니다. 어떤 Feature의 각 구간(bin)에 대한 (범주형일 경우 각 level) 정보 가치 값은 <span class="math display">\[IV_i = (Event_i\% - NonEvent_i\%)\times WoE_i\]</span>으로 표현할 수 있고, 해당 Feature의 정보가치는 이를 모두 더한 <span class="math display">\[IV = \sum IV_i = \sum\{(Event_i\% - NonEvent_i\%)\times WoE_i\}\]</span> 으로 정의할 수 있습니다.</p>
<p>이러한 feature 별 IV 값에 대한 통상적인 기준은 아래와 같습니다.</p>
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full"><p><img src="https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&amp;fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdn%2FsqkdV%2Fbtr8wPiFwWb%2FB7ugBV1LB50Rjgm6tfU9tK%2Fimg.jpg" class="img-fluid figure-img"></p>
<figcaption class="figure-caption margin-caption">IV 값에 따른 예측력</figcaption></figure>
</div>
<p>자세한 내용은 <a href="https://recipesds.tistory.com/entry/Logistic-%EC%98%88%EC%B8%A1-%EB%AA%A8%ED%98%95%EC%97%90%EC%84%9C%EC%9D%98-%EB%B3%80%EC%88%98-%EC%84%A0%ED%83%9D-%EB%B0%A9%EB%B2%95-Information-Value">Logistic 예측 모형에서의 변수 선택 방법 - Information Value</a>을 참고하시면 됩니다.</p>
<p>이제 앞서 구성한 Data Mart(<code>df_mart</code>)의 각 feature에 대해서 IV 값을 구해보겠습니다.</p>
<div class="cell" data-hash="index_cache/html/unnamed-chunk-13_aaeac970a7512058e812f8acd27c9e67">
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">df_mart</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">reframe</span><span class="op">(</span><span class="fu">across</span><span class="op">(</span><span class="fu">everything</span><span class="op">(</span><span class="op">)</span>, <span class="va">typeof</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 17
  bsym      CustomerID total_amt max_amt min_amt total_cnt max_cnt min_cnt total_qty max_qty min_qty Country   peak_time season    freq   avg_amt target
  &lt;chr&gt;     &lt;chr&gt;      &lt;chr&gt;     &lt;chr&gt;   &lt;chr&gt;   &lt;chr&gt;     &lt;chr&gt;   &lt;chr&gt;   &lt;chr&gt;     &lt;chr&gt;   &lt;chr&gt;   &lt;chr&gt;     &lt;chr&gt;     &lt;chr&gt;     &lt;chr&gt;  &lt;chr&gt;   &lt;chr&gt; 
1 character character  double    double  double  integer   integer integer integer   integer integer character character character double double  double</code></pre>
</div>
</div>
<p>우선 수치형 변수들에 대해 각각 5% 단위로 binning을 해주고, 40%, 75% 백분위수를 기준으로 3개의 그룹으로 구간화를 시켜주겠습니다.</p>
<div class="cell" data-hash="index_cache/html/unnamed-chunk-14_da39c9bd6f5419b4b0d930e7b9e34ee9">
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">iv_calculate</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>, <span class="va">var</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">quant</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span><span class="op">(</span><span class="va">data</span><span class="op">[[</span><span class="va">var</span><span class="op">]</span><span class="op">]</span>, probs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.40</span>, <span class="fl">0.75</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">iv</span> <span class="op">&lt;-</span> <span class="va">data</span> <span class="op">%&gt;%</span> </span>
<span>    <span class="fu">mutate</span><span class="op">(</span>grp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/findInterval.html">findInterval</a></span><span class="op">(</span><span class="va">.data</span><span class="op">[[</span><span class="va">var</span><span class="op">]</span><span class="op">]</span>, <span class="va">quant</span>, rightmost.closed <span class="op">=</span> <span class="cn">T</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span>,</span>
<span>           n_target <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">target</span><span class="op">==</span><span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>    <span class="fu">group_by</span><span class="op">(</span><span class="va">grp</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>    <span class="fu">reframe</span><span class="op">(</span></span>
<span>      target <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">target</span>, na.rm <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>,</span>
<span>      n_target <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">n_target</span>, na.rm <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span>
<span>    <span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>    <span class="fu">mutate</span><span class="op">(</span></span>
<span>      good_pct <span class="op">=</span> <span class="va">target</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">target</span><span class="op">)</span>,</span>
<span>      bad_pct <span class="op">=</span> <span class="va">n_target</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">n_target</span><span class="op">)</span>,</span>
<span>      t_ratio <span class="op">=</span> <span class="va">target</span> <span class="op">/</span> <span class="op">(</span><span class="va">target</span> <span class="op">+</span> <span class="va">n_target</span><span class="op">)</span>,</span>
<span>      VAR <span class="op">=</span> <span class="va">var</span>,</span>
<span>      iv <span class="op">=</span> <span class="op">(</span><span class="va">good_pct</span> <span class="op">-</span> <span class="va">bad_pct</span><span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">good_pct</span> <span class="op">/</span> <span class="va">bad_pct</span><span class="op">)</span></span>
<span>    <span class="op">)</span> </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">iv</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">numeric_cols</span> <span class="op">&lt;-</span> <span class="va">df_mart</span> <span class="op">%&gt;%</span> <span class="fu">select_if</span><span class="op">(</span><span class="va">is.numeric</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu">select</span><span class="op">(</span><span class="op">-</span><span class="va">target</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">iv_df</span> <span class="op">&lt;-</span> <span class="fu">map_dfr</span><span class="op">(</span><span class="va">numeric_cols</span>, <span class="op">~</span> <span class="fu">iv_calculate</span><span class="op">(</span><span class="va">df_mart</span>, <span class="va">.x</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">iv_df</span>, n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">iv_df</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 30 × 8
     grp target n_target good_pct bad_pct t_ratio VAR             iv
   &lt;dbl&gt;  &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt; &lt;chr&gt;        &lt;dbl&gt;
 1     1    853     2145    0.298  0.463    0.285 total_amt 0.0719  
 2     2    974     1649    0.341  0.356    0.371 total_amt 0.000631
 3     3   1031      843    0.361  0.182    0.550 total_amt 0.123   
 4     1    909     2089    0.318  0.451    0.303 max_amt   0.0461  
 5     2   1015     1608    0.355  0.347    0.387 max_amt   0.000200
 6     3    934      940    0.327  0.203    0.498 max_amt   0.0593  
 7     1   1113     1885    0.389  0.407    0.371 min_amt   0.000733
 8     2   1015     1608    0.355  0.347    0.387 min_amt   0.000200
 9     3    730     1144    0.255  0.247    0.390 min_amt   0.000302
10     2   2350     4476    0.822  0.965    0.344 total_cnt 0.0229  
11     3    508      161    0.178  0.0347   0.759 total_cnt 0.234   
12     1   1037     1897    0.363  0.409    0.353 max_cnt   0.00555 
13     2   1059     1675    0.371  0.361    0.387 max_cnt   0.000237
14     3    762     1065    0.267  0.230    0.417 max_cnt   0.00551 
15     1   1199     1716    0.420  0.370    0.411 min_cnt   0.00620 
16     2   1004     1719    0.351  0.371    0.369 min_cnt   0.00104 
17     3    655     1202    0.229  0.259    0.353 min_cnt   0.00370 
18     1    886     2104    0.310  0.454    0.296 total_qty 0.0548  
19     2    985     1647    0.345  0.355    0.374 total_qty 0.000318
20     3    987      886    0.345  0.191    0.527 total_qty 0.0913  
21     1    667     1435    0.233  0.309    0.317 max_qty   0.0215  
22     2   1348     2259    0.472  0.487    0.374 max_qty   0.000502
23     3    843      943    0.295  0.203    0.472 max_qty   0.0341  
24     2   2128     3524    0.745  0.760    0.377 min_qty   0.000315
25     3    730     1113    0.255  0.240    0.396 min_qty   0.000957
26     2   2081     4195    0.728  0.905    0.332 freq      0.0383  
27     3    777      442    0.272  0.0953   0.637 freq      0.185   
28     1    963     2035    0.337  0.439    0.321 avg_amt   0.0269  
29     2   1030     1593    0.360  0.344    0.393 avg_amt   0.000807
30     3    865     1009    0.303  0.218    0.462 avg_amt   0.0281  </code></pre>
</div>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Feature 별 IV 값 합산</span></span>
<span><span class="va">iv_df</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">VAR</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">reframe</span><span class="op">(</span>iv <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">iv</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">arrange</span><span class="op">(</span><span class="fu">desc</span><span class="op">(</span><span class="va">iv</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 11 × 2
   VAR            iv
   &lt;chr&gt;       &lt;dbl&gt;
 1 total_cnt 0.257  
 2 freq      0.223  
 3 total_amt 0.195  
 4 total_qty 0.146  
 5 max_amt   0.106  
 6 max_qty   0.0560 
 7 avg_amt   0.0558 
 8 max_cnt   0.0113 
 9 min_cnt   0.0109 
10 min_qty   0.00127
11 min_amt   0.00123</code></pre>
</div>
</div>
<p>수치형 변수들에 대해서 이렇게 직접 구간(bin)의 경계값을 지정해서 binning을 할 수 있습니다. 이번에는 <code>target</code> 변수를 잘 예측하는, 즉 변수별 IV 값이 높게 나오도록 구간화를 하는 방법을 소개하겠습니다. 이러한 방법을 optimized binning이라고 합니다.</p>
<p><code>dlookr</code> 패키지의 <code><a href="https://choonghyunryu.github.io/dlookr/reference/binning_by.html">binning_by()</a></code> 함수는 반응변수(<code>target</code>)을 가장 잘 예측하는 경계값으로 수치형 변수를 binning 하기 때문에 변수별로 bin의 개수가 다를 수 있으며, 수치형 변수가 <code>target</code>과 유의한 관계가 없는 경우 구간화를 하지 않아서 변수 선택을 고려할 수도 있습니다.</p>
<div class="cell" data-hash="index_cache/html/unnamed-chunk-15_ef6ca17cc534e236ab93ea948cc59c7e">
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/choonghyunryu/dlookr/">dlookr</a></span><span class="op">)</span></span>
<span><span class="va">numeric_cols</span> <span class="op">&lt;-</span> <span class="va">df_mart</span> <span class="op">%&gt;%</span> <span class="fu">select_if</span><span class="op">(</span><span class="va">is.numeric</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu">select</span><span class="op">(</span><span class="op">-</span><span class="va">target</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># binning_by() 이용 시 target과 유의하지 않은 변수는 구간화를 하지 않음</span></span>
<span><span class="va">bin_process</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>, <span class="va">var</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/conditions.html">tryCatch</a></span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="va">bin</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://choonghyunryu.github.io/dlookr/reference/binning_by.html">binning_by</a></span><span class="op">(</span><span class="va">data</span>, <span class="va">target</span>, <span class="va">var</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/attr.html">attr</a></span><span class="op">(</span><span class="va">bin</span>, <span class="st">"name"</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">var</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">bin</span><span class="op">)</span></span>
<span>  <span class="op">}</span>, warning <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">w</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">bin</span> <span class="op">&lt;-</span> <span class="st">"No significant splits"</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/attr.html">attr</a></span><span class="op">(</span><span class="va">bin</span>, <span class="st">"name"</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">var</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">bin</span><span class="op">)</span></span>
<span>  <span class="op">}</span>, error <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">e</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">bin</span> <span class="op">&lt;-</span> <span class="st">"Error"</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/attr.html">attr</a></span><span class="op">(</span><span class="va">bin</span>, <span class="st">"name"</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">var</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">bin</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">bin_list</span> <span class="op">&lt;-</span> <span class="fu">map</span><span class="op">(</span><span class="va">numeric_cols</span>, <span class="op">~</span><span class="fu">bin_process</span><span class="op">(</span><span class="va">df_mart</span>, <span class="va">.x</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-hash="index_cache/html/unnamed-chunk-16_7bbc461ab0fbeb140af6b9c6d78cbc0a">

</div>
<div class="cell" data-hash="index_cache/html/unnamed-chunk-17_675123f57d5041dd5b493b9942637266">
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># target과 유의하지 않은 변수 확인:</span></span>
<span><span class="va">bin_list</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">keep</span><span class="op">(</span><span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/typeof.html">typeof</a></span><span class="op">(</span><span class="va">.x</span><span class="op">)</span> <span class="op">==</span> <span class="st">"character"</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">map</span><span class="op">(</span><span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/attr.html">attr</a></span><span class="op">(</span><span class="va">.x</span>, <span class="st">"name"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "min_amt" "min_qty"</code></pre>
</div>
</div>
<p>앞서 40%, 75% 백분위수 값을 경계로 IV 값을 구했 때 가장 낮은 IV 값을 가졌던 <code>min_amt</code>와 <code>min_qty</code>는 최적 구간으로 IV 값을 구했을 경우에도 <code>target</code>과 유의하지 않다고 판단되므로 고려하지 않겠습니다.</p>
<p>Optimized binning이 각 수치형 변수의 몇 % 백분위수를 bin의 경계값으로 삼는지 확인해 보겠습니다.</p>
<div class="cell" data-hash="index_cache/html/unnamed-chunk-18_12f65cddccaa269a245c03efbf131c4b">
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">bin_cutoff</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>, <span class="va">bin</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="co"># cutoff level </span></span>
<span>  <span class="va">cutoff</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/attr.html">attr</a></span><span class="op">(</span><span class="va">bin</span>, <span class="st">"breaks"</span><span class="op">)</span></span>
<span>  <span class="va">grp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">cutoff</span><span class="op">)</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="kw">if</span><span class="op">(</span><span class="va">i</span><span class="op">==</span><span class="fl">1</span><span class="op">)</span><span class="op">{</span></span>
<span>      <span class="va">brk</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"["</span>, <span class="va">cutoff</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="st">","</span>, <span class="va">cutoff</span><span class="op">[</span><span class="va">i</span><span class="op">+</span><span class="fl">1</span><span class="op">]</span>, <span class="st">"]"</span><span class="op">)</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span><span class="op">{</span></span>
<span>      <span class="va">brk</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"("</span>, <span class="va">cutoff</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="st">","</span>, <span class="va">cutoff</span><span class="op">[</span><span class="va">i</span><span class="op">+</span><span class="fl">1</span><span class="op">]</span>, <span class="st">"]"</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="va">grp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">grp</span>, <span class="va">brk</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/attr.html">attr</a></span><span class="op">(</span><span class="va">bin</span>, <span class="st">"levels"</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">grp</span></span>
<span>  <span class="co"># data의 수치형변수에서 해당 cutoff가 몇% 백분위수 인지</span></span>
<span>  <span class="va">value</span> <span class="op">&lt;-</span> <span class="va">cutoff</span><span class="op">[</span><span class="fl">2</span><span class="op">:</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">cutoff</span><span class="op">)</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">]</span></span>
<span>  <span class="va">ecdf_func</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/ecdf.html">ecdf</a></span><span class="op">(</span><span class="va">data</span><span class="op">[[</span><span class="fu"><a href="https://rdrr.io/r/base/attr.html">attr</a></span><span class="op">(</span><span class="va">bin</span>, <span class="st">"name"</span><span class="op">)</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="va">percentile</span> <span class="op">&lt;-</span> <span class="fu">ecdf_func</span><span class="op">(</span><span class="va">value</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>Var <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/attr.html">attr</a></span><span class="op">(</span><span class="va">bin</span>, <span class="st">"name"</span><span class="op">)</span>, </span>
<span>                    cutoff <span class="op">=</span> <span class="va">value</span>,</span>
<span>                    percentile <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/percent_format.html">percent</a></span><span class="op">(</span><span class="va">percentile</span>, accuracy <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">sig_bin_list</span> <span class="op">&lt;-</span> <span class="va">bin_list</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">keep</span><span class="op">(</span><span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/typeof.html">typeof</a></span><span class="op">(</span><span class="va">.x</span><span class="op">)</span> <span class="op">==</span> <span class="st">"integer"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Optimized bin의 경계값 분위수 확인</span></span>
<span><span class="va">sig_bin_list</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">map</span><span class="op">(</span><span class="op">~</span><span class="fu">bin_cutoff</span><span class="op">(</span><span class="va">df_mart</span>, <span class="va">.x</span><span class="op">)</span><span class="op">)</span> </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]
        Var  cutoff percentile
1 total_amt  138.70        14%
2 total_amt  219.82        26%
3 total_amt  542.10        70%
4 total_amt 1878.72        94%

[[2]]
      Var  cutoff percentile
1 max_amt  173.36        20%
2 max_amt  477.46        72%
3 max_amt 1136.68        94%

[[3]]
        Var cutoff percentile
1 total_cnt      1        74%
2 total_cnt      2        92%

[[4]]
      Var cutoff percentile
1 max_cnt      3         8%
2 max_cnt     44        86%

[[5]]
      Var cutoff percentile
1 min_cnt      4        20%
2 min_cnt     32        84%

[[6]]
        Var cutoff percentile
1 total_qty     95        22%
2 total_qty    235        58%
3 total_qty    363        74%
4 total_qty   1047        94%

[[7]]
      Var cutoff percentile
1 max_qty     19        26%
2 max_qty     90        84%
3 max_qty    144        94%

[[8]]
   Var     cutoff percentile
1 freq 0.03225806        42%
2 freq 0.03571429        74%
3 freq 0.07142857        92%

[[9]]
      Var    cutoff percentile
1 avg_amt  154.6950        18%
2 avg_amt  273.6600        44%
3 avg_amt  521.0000        80%
4 avg_amt  609.6733        84%
5 avg_amt 1090.7600        94%</code></pre>
</div>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Optimized binning 후 IV 값 확인</span></span>
<span><span class="va">sig_bin_list</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">map</span><span class="op">(</span><span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>name <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/attr.html">attr</a></span><span class="op">(</span><span class="va">.x</span>, <span class="st">"name"</span><span class="op">)</span>,</span>
<span>                  IV <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/attr.html">attr</a></span><span class="op">(</span><span class="va">.x</span>, <span class="st">"performance"</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu">pull</span><span class="op">(</span><span class="va">IV</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="va">.</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">list_rbind</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">arrange</span><span class="op">(</span><span class="fu">desc</span><span class="op">(</span><span class="va">IV</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       name      IV
1 total_cnt 0.36390
2      freq 0.36390
3 total_amt 0.28501
4 total_qty 0.21204
5   max_amt 0.12493
6   max_qty 0.08274
7   avg_amt 0.07401
8   max_cnt 0.03034
9   min_cnt 0.01942</code></pre>
</div>
</div>
<p>낮은 IV 값을 가졌던 <code>min_qty</code>와 <code>min_amt</code>를 제외하고 비교해보면, 직접 구간화를 했을 때보다 전반적으로 IV 값들이 높아졌습니다.</p>
<p>Binning 후 각 구간의 분포와 <code>target</code>이 1일 때의 분포 그래프를 확인할 수도 있습니다. 아래는 <code>total_cnt</code>의 최적 구간화 이후 각 구간별 분포와, <code>target</code>이 1인 것의 분포를 나타냅니다.</p>
<div class="cell page-columns page-full" data-hash="index_cache/html/fig-2_b41a4ae560583addc34df33c93b009e5">
<details><summary>Code</summary><div class="sourceCode" id="cb44"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://patchwork.data-imaginist.com">patchwork</a></span><span class="op">)</span></span>
<span><span class="va">total_cnt_bin</span> <span class="op">&lt;-</span> <span class="va">sig_bin_list</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">keep</span><span class="op">(</span><span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/attr.html">attr</a></span><span class="op">(</span><span class="va">.x</span>, <span class="st">"name"</span><span class="op">)</span> <span class="op">==</span> <span class="st">"total_cnt"</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="va">.</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> </span>
<span><span class="va">p1</span> <span class="op">&lt;-</span> <span class="va">total_cnt_bin</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">"freq"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span></span>
<span><span class="va">p2</span> <span class="op">&lt;-</span> <span class="va">total_cnt_bin</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">"posrate"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span></span>
<span><span class="va">p1</span> <span class="op">+</span> <span class="va">p2</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display page-columns page-full">
<div id="fig-2" class="quarto-figure quarto-figure-center anchored page-columns page-full">
<figure class="figure page-columns page-full"><p><img src="index_files/figure-html/fig-2-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption class="figure-caption margin-caption">Figure&nbsp;2: total_cnt binning 후 분포</figcaption></figure>
</div>
</div>
</div>
</section></section><section id="categorical-feature-engineering" class="level2 page-columns page-full"><h2 class="anchored" data-anchor-id="categorical-feature-engineering">03-03. Categorical Feature Engineering</h2>
<p>범주형 변수인 <code>Country</code>, <code>peak_time</code>, <code>season</code>에 대해서도 IV 값을 구해서 <code>target</code> 변수와의 관계를 살펴보겠습니다.</p>
<p>우선 국적 변수인 <code>Country</code>에 대해 살펴보겠습니다.</p>
<div class="cell" data-hash="index_cache/html/unnamed-chunk-20_22611fc5ca1de0cd13d4322096233725">
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># 국적 Country 변수 unique한 값 수</span></span>
<span><span class="va">df_mart</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">reframe</span><span class="op">(</span>n_uniq <span class="op">=</span> <span class="fu">n_distinct</span><span class="op">(</span><span class="va">Country</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 1
  n_uniq
   &lt;int&gt;
1     33</code></pre>
</div>
</div>
<div class="cell page-columns page-full" data-hash="index_cache/html/fig-3_7d78f508cbd4f1a398b4d18d33e423e9">
<details><summary>Code</summary><div class="sourceCode" id="cb47"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">df_mart</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="va">Country</span>, fill <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">target</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_bar</span><span class="op">(</span>position <span class="op">=</span> <span class="st">"dodge"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_minimal</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_flip</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"Target"</span>, x <span class="op">=</span> <span class="st">"Country"</span>, y <span class="op">=</span> <span class="st">"Count"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display page-columns page-full">
<div id="fig-3" class="quarto-figure quarto-figure-center anchored page-columns page-full">
<figure class="figure page-columns page-full"><p><img src="index_files/figure-html/fig-3-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption class="figure-caption margin-caption">Figure&nbsp;3: 국적별 target 분포</figcaption></figure>
</div>
</div>
</div>
<p><a href="#fig-3">Figure&nbsp;3</a> 을 보면 <code>Country</code> 변수의 대부분이 영국(United Kingdom)임을 알 수 있습니다. 따라서 영국을 제외한 나머지 값들은 기타 국가로 변경하겠습니다.</p>
<div class="cell" data-hash="index_cache/html/unnamed-chunk-22_e4ea7c0844cd9b3de316cb8b7a3c026d">
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">df_mart</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">count</span><span class="op">(</span><span class="va">Country</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">arrange</span><span class="op">(</span><span class="fu">desc</span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>ratio <span class="op">=</span> <span class="va">n</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 33 × 3
   Country            n   ratio
   &lt;chr&gt;          &lt;int&gt;   &lt;dbl&gt;
 1 United Kingdom  6871 0.917  
 2 Germany          150 0.0200 
 3 France           144 0.0192 
 4 Belgium           38 0.00507
 5 Spain             33 0.00440
 6 Australia         25 0.00334
 7 Italy             25 0.00334
 8 Netherlands       23 0.00307
 9 Switzerland       23 0.00307
10 Portugal          22 0.00294
# ℹ 23 more rows</code></pre>
</div>
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># UK 이외의 기타 국가로 처리</span></span>
<span><span class="va">df_mart</span> <span class="op">&lt;-</span> <span class="va">df_mart</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>Country <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">Country</span><span class="op">==</span><span class="st">"United Kingdom"</span>, <span class="st">"UK"</span>, <span class="st">"ETC"</span><span class="op">)</span><span class="op">)</span> </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>이제 범주형 변수인 <code>Country</code>, <code>peak_time</code>, <code>season</code>의 IV 값을 구해보겠습니다.</p>
<div class="cell" data-hash="index_cache/html/unnamed-chunk-23_4073d5f117e9a58ee18a622dfd00682d">
<div class="sourceCode" id="cb51"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/ShichenXie/scorecard">scorecard</a></span><span class="op">)</span></span>
<span><span class="va">Country_iv</span> <span class="op">&lt;-</span> <span class="fu"><a href="http://shichen.name/scorecard/reference/woebin.html">woebin</a></span><span class="op">(</span><span class="va">df_mart</span>, <span class="st">"target"</span>, <span class="st">"Country"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>✔ Binning on 7495 rows and 2 columns in 00:00:01</code></pre>
</div>
<div class="sourceCode" id="cb53"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">peak_iv</span> <span class="op">&lt;-</span> <span class="fu"><a href="http://shichen.name/scorecard/reference/woebin.html">woebin</a></span><span class="op">(</span><span class="va">df_mart</span>, <span class="st">"target"</span>, <span class="st">"peak_time"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>✔ Binning on 7495 rows and 2 columns in 00:00:01</code></pre>
</div>
<div class="sourceCode" id="cb55"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">season_iv</span> <span class="op">&lt;-</span> <span class="fu"><a href="http://shichen.name/scorecard/reference/woebin.html">woebin</a></span><span class="op">(</span><span class="va">df_mart</span>, <span class="st">"target"</span>, <span class="st">"season"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>✔ Binning on 7495 rows and 2 columns in 00:00:01</code></pre>
</div>
<div class="sourceCode" id="cb57"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Country IV </span></span>
<span><span class="va">Country_iv</span><span class="op">$</span><span class="va">Country</span> <span class="op">%&gt;%</span> <span class="fu">tibble</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 12
  variable bin   count count_distr   neg   pos posprob      woe  bin_iv total_iv
  &lt;chr&gt;    &lt;chr&gt; &lt;int&gt;       &lt;dbl&gt; &lt;int&gt; &lt;int&gt;   &lt;dbl&gt;    &lt;dbl&gt;   &lt;dbl&gt;    &lt;dbl&gt;
1 Country  ETC     624      0.0833   387   237   0.380 -6.42e-3 3.43e-6  3.74e-6
2 Country  UK     6871      0.917   4250  2621   0.381  5.82e-4 3.11e-7  3.74e-6
# ℹ 2 more variables: breaks &lt;chr&gt;, is_special_values &lt;lgl&gt;</code></pre>
</div>
<div class="sourceCode" id="cb59"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># peak_time IV</span></span>
<span><span class="va">peak_iv</span><span class="op">$</span><span class="va">peak_time</span> <span class="op">%&gt;%</span> <span class="fu">tibble</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 12
  variable  bin   count count_distr   neg   pos posprob     woe  bin_iv total_iv
  &lt;chr&gt;     &lt;chr&gt; &lt;int&gt;       &lt;dbl&gt; &lt;int&gt; &lt;int&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;    &lt;dbl&gt;
1 peak_time Afte…  4845       0.646  3019  1826   0.377 -0.0189 2.29e-4 0.000646
2 peak_time Morn…  2650       0.354  1618  1032   0.389  0.0343 4.16e-4 0.000646
# ℹ 2 more variables: breaks &lt;chr&gt;, is_special_values &lt;lgl&gt;</code></pre>
</div>
<div class="sourceCode" id="cb61"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># season IV</span></span>
<span><span class="va">season_iv</span><span class="op">$</span><span class="va">season</span> <span class="op">%&gt;%</span> <span class="fu">tibble</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 12
  variable bin    count count_distr   neg   pos posprob     woe  bin_iv total_iv
  &lt;chr&gt;    &lt;chr&gt;  &lt;int&gt;       &lt;dbl&gt; &lt;int&gt; &lt;int&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;    &lt;dbl&gt;
1 season   Autumn  2563       0.342  1616   947   0.369 -0.0505 8.65e-4  0.00350
2 season   Sprin…  3206       0.428  1996  1210   0.377 -0.0166 1.17e-4  0.00350
3 season   Summer  1726       0.230  1025   701   0.406  0.104  2.52e-3  0.00350
# ℹ 2 more variables: breaks &lt;chr&gt;, is_special_values &lt;lgl&gt;</code></pre>
</div>
</div>
<p><code>target</code> 변수에 대한 범주형 변수들의 IV 값을 보면 굉장히 낮으므로 이 세 변수는 <code>target</code> 변수와 유의미한 관계가 없어 보입니다.</p>


</section></section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var filterRegex = new RegExp("https:\/\/gwook\.blog");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
          // target, if specified
          link.setAttribute("target", "_blank");
      }
    }
});
</script><script src="https://utteranc.es/client.js" repo="YoonGeonWook/GWook-com" issue-term="pathname" theme="github-light" crossorigin="anonymous" async="">
</script>
</div> <!-- /content -->



</body></html>